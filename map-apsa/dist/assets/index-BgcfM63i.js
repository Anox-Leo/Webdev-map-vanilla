var k=Object.defineProperty;var D=(d,t,e)=>t in d?k(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var n=(d,t,e)=>D(d,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=e(r);fetch(r.href,s)}})();class N{constructor(t){n(this,"scale",1);n(this,"posX",0);n(this,"posY",0);n(this,"minScale",.5);n(this,"maxScale",5);n(this,"zoomStep",.1);n(this,"rotateX",40);n(this,"rotateZ",0);n(this,"defaultRotateX",40);n(this,"mapSvg");this.mapSvg=t,this.updateMapTransform()}setFlatMode(t){t?(this.rotateX!==0&&(this.defaultRotateX=this.rotateX),this.rotateX=0):this.rotateX=this.defaultRotateX,this.updateMapTransform()}zoomIn(){const t=Math.min(this.maxScale,this.scale*(1+this.zoomStep));this.zoomTo(t)}zoomOut(){const t=Math.max(this.minScale,this.scale/(1+this.zoomStep));this.zoomTo(t)}zoomTo(t){this.scale=t,this.updateMapTransform()}zoomAtPoint(t,e,i,r){t=Math.max(this.minScale,Math.min(this.maxScale,t));const s=r.getBoundingClientRect(),o=e-s.left-s.width/2,a=i-s.top-s.height/2,u=t/this.scale,l=o-o*u,c=a-a*u,h=Math.cos(this.rotateX*Math.PI/180),m=-this.rotateZ*Math.PI/180,p=l*Math.cos(m)+c*Math.sin(m)*h,g=-l*Math.sin(m)+c*Math.cos(m)*h;this.scale=t,this.posX+=p,this.posY+=g,this.updateMapTransform()}resetView(){this.scale=1,this.posX=0,this.posY=0,this.rotateZ=0,this.updateMapTransform()}resetRotation(){this.rotateZ=0,this.updateMapTransform()}updatePosition(t,e){this.posX+=t,this.posY+=e,this.updateMapTransform()}updateRotation(t){this.rotateZ=t,this.updateMapTransform()}updateMapTransform(){this.mapSvg&&(this.mapSvg.style.transform=`rotateX(${this.rotateX}deg) rotateZ(${-this.rotateZ}deg) scale(${this.scale}) translate(${this.posX}px, ${this.posY}px)`)}getScale(){return this.scale}getRotateX(){return this.rotateX}getRotateZ(){return this.rotateZ}getZoomStep(){return this.zoomStep}}class x{constructor(t,e){n(this,"isDragging",!1);n(this,"startPosX",0);n(this,"startPosY",0);n(this,"mapView");n(this,"transformController");n(this,"currentMode",v.GRABBING);n(this,"enabled",!0);this.mapView=t,this.transformController=e}setupEventListeners(){this.mapView&&(this.mapView.addEventListener("mousedown",t=>{!this.enabled||this.currentMode===v.FLAT||this.isControlElement(t.target)||this.startDrag(t)}),window.addEventListener("mousemove",t=>{this.isDragging&&this.enabled&&this.moveDrag(t)}),window.addEventListener("mouseup",()=>{this.endDrag()}),window.addEventListener("mouseleave",()=>{this.endDrag()}))}setEnabled(t){this.enabled=t,!t&&this.isDragging&&this.endDrag(),this.mapView&&(t&&this.currentMode===v.GRABBING?this.mapView.style.cursor="grab":t||(this.mapView.style.cursor="default"))}setDisplayMode(t){this.currentMode=t,this.isDragging&&this.endDrag()}isControlElement(t){return t.closest(".map-controls")!==null||t.closest(".compass-container")!==null||t.closest(".map-mode-selector")!==null}startDrag(t){!this.mapView||!this.enabled||this.currentMode===v.FLAT||(this.isDragging=!0,this.startPosX=t.clientX,this.startPosY=t.clientY,this.mapView.classList.add("dragging"),t.preventDefault())}moveDrag(t){if(!this.isDragging||!this.enabled||this.currentMode===v.FLAT)return;const e=this.transformController.getScale(),i=1/Math.sqrt(e),r=this.transformController.getRotateX(),s=Math.cos(r*Math.PI/180),o=(t.clientX-this.startPosX)*i,a=(t.clientY-this.startPosY)*i*s,l=-this.transformController.getRotateZ()*Math.PI/180,c=o*Math.cos(l)+a*Math.sin(l),h=-o*Math.sin(l)+a*Math.cos(l);this.transformController.updatePosition(c,h),this.startPosX=t.clientX,this.startPosY=t.clientY}endDrag(){!this.mapView||!this.isDragging||(this.isDragging=!1,this.mapView.classList.remove("dragging"))}isDraggingActive(){return this.isDragging}}class B{constructor(t){n(this,"isRotating",!1);n(this,"compassCenter",{x:0,y:0});n(this,"lastAngle",0);n(this,"compassRotator",null);n(this,"compassHandle",null);n(this,"compassResetBtn",null);n(this,"mapSvg",null);n(this,"transformController");n(this,"currentMode",v.GRABBING);n(this,"enabled",!0);this.transformController=t,this.compassRotator=document.getElementById("compass-rotator"),this.compassHandle=document.querySelector(".compass-handle"),this.compassResetBtn=document.getElementById("compass-reset"),this.mapSvg=document.getElementById("map-svg")}setEnabled(t){this.enabled=t,!t&&this.isRotating&&this.endRotation(),this.compassRotator&&(t?this.currentMode!==v.FLAT&&this.compassRotator.classList.remove("disabled"):this.compassRotator.classList.add("disabled"))}setDisplayMode(t){this.currentMode=t,this.compassRotator&&this.compassHandle&&(t===v.FLAT?this.compassRotator.classList.add("disabled"):this.enabled&&this.compassRotator.classList.remove("disabled")),this.isRotating&&t===v.FLAT&&this.endRotation()}setupEventListeners(){this.compassRotator&&(this.compassRotator.addEventListener("mousedown",t=>{this.currentMode===v.FLAT||!this.enabled||this.startRotation(t)}),this.compassRotator.addEventListener("touchstart",t=>{this.currentMode===v.FLAT||!this.enabled||t.touches.length===1&&(t.preventDefault(),this.startRotation(t.touches[0]))},{passive:!1}),window.addEventListener("mousemove",t=>{this.isRotating&&this.enabled&&this.moveRotation(t)}),window.addEventListener("touchmove",t=>{this.isRotating&&this.enabled&&t.touches.length===1&&(t.preventDefault(),this.moveRotation(t.touches[0]))},{passive:!1}),window.addEventListener("mouseup",()=>{this.endRotation()}),window.addEventListener("touchend",()=>{this.endRotation()})),this.compassResetBtn&&this.compassResetBtn.addEventListener("click",()=>{this.enabled&&this.resetRotation()})}startRotation(t){if(!this.compassRotator||!this.enabled||this.currentMode===v.FLAT)return;this.isRotating=!0;const e=this.compassRotator.getBoundingClientRect();this.compassCenter={x:e.left+e.width/2,y:e.top+e.height/2},this.lastAngle=this.calculateAngle(t.clientX,t.clientY),this.compassHandle&&this.compassHandle.classList.add("rotating"),this.mapSvg&&this.mapSvg.classList.add("rotating")}moveRotation(t){if(!this.isRotating||!this.enabled)return;const e=this.calculateAngle(t.clientX,t.clientY);let i=e-this.lastAngle;i>180&&(i-=360),i<-180&&(i+=360);let s=(this.transformController.getRotateZ()+i)%360;s<0&&(s+=360),this.transformController.updateRotation(s),this.updateCompassHandle(),this.updateDirectionIndicator(),this.lastAngle=e}endRotation(){this.isRotating=!1,this.compassHandle&&this.compassHandle.classList.remove("rotating"),this.mapSvg&&this.mapSvg.classList.remove("rotating")}calculateAngle(t,e){const i=t-this.compassCenter.x,r=e-this.compassCenter.y;let s=Math.atan2(r,i)*180/Math.PI;return s=(s+90)%360,s<0&&(s+=360),s}updateCompassHandle(){if(!this.compassRotator)return;const t=this.transformController.getRotateZ(),e=this.compassRotator.clientWidth/2-8,i=t*Math.PI/180,r=Math.sin(i)*e,s=-Math.cos(i)*e;this.compassHandle&&(this.compassHandle.style.transform=`translate(-50%, -50%) translate(${r}px, ${s}px)`,this.compassHandle.style.top="50%",this.compassHandle.style.left="50%");const o=this.compassRotator
.querySelector(".compass-line");if(o){o.style.position="absolute",o.style.top="50%",o.style.left="50%";const a=this.compassRotator.clientWidth/2;o.style.width=`${a}px`,o.style.height="20px";let u=t-90;u=u%360,u<0&&(u+=360),o.style.background="linear-gradient(to right, rgba(70, 130, 220, 0.1), rgba(70, 130, 220, 0.6))",o.style.clipPath="polygon(0 50%, 100% 0, 100% 100%)",o.style.transform=`translateY(-50%) rotate(${u}deg)`,o.style.transformOrigin="left center",o.style.borderRadius="0 5px 5px 0",o.style.zIndex="0"}}updateDirectionIndicator(){var i,r,s,o;const t=document.querySelectorAll(".compass-direction");if(!t.length)return;const e=this.transformController.getRotateZ();t.forEach(a=>a.classList.remove("active")),e>=315||e<45?(i=document.querySelector(".compass-direction.north"))==null||i.classList.add("active"):e>=45&&e<135?(r=document.querySelector(".compass-direction.east"))==null||r.classList.add("active"):e>=135&&e<225?(s=document.querySelector(".compass-direction.south"))==null||s.classList.add("active"):(o=document.querySelector(".compass-direction.west"))==null||o.classList.add("active")}resetRotation(){this.transformController.resetRotation(),this.updateCompassHandle(),this.updateDirectionIndicator()}isRotatingActive(){return this.isRotating}}class R{constructor(t,e,i,r){n(this,"mapView");n(this,"zoomInBtn",null);n(this,"zoomOutBtn",null);n(this,"resetBtn",null);n(this,"transformController");n(this,"compassController");n(this,"dragController");n(this,"currentMode",v.GRABBING);this.mapView=t,this.transformController=e,this.compassController=i,this.dragController=r,this.zoomInBtn=document.getElementById("zoom-in"),this.zoomOutBtn=document.getElementById("zoom-out"),this.resetBtn=document.getElementById("reset")}setDisplayMode(t){this.currentMode=t}setupEventListeners(){!this.mapView||!this.zoomInBtn||!this.zoomOutBtn||!this.resetBtn||(this.zoomInBtn.addEventListener("click",()=>{this.transformController.zoomIn()}),this.zoomOutBtn.addEventListener("click",()=>{this.transformController.zoomOut()}),this.resetBtn.addEventListener("click",()=>{this.transformController.resetView(),this.compassController.updateCompassHandle(),this.compassController.updateDirectionIndicator()}),this.mapView.addEventListener("wheel",t=>{if(t.preventDefault(),this.currentMode===v.FLAT&&this.transformController.setFlatMode(!0),this.compassController.isRotatingActive())return;const e=this.mapView.closest("#map-container");if(!e)return;const i=this.transformController.getZoomStep();t.deltaY<0?this.transformController.zoomAtPoint(this.transformController.getScale()*(1+i*.3),t.clientX,t.clientY,e):this.transformController.zoomAtPoint(this.transformController.getScale()/(1+i*.3),t.clientX,t.clientY,e)},{passive:!1}),this.mapView.addEventListener("dblclick",t=>{if(this.currentMode===v.FLAT&&this.transformController.setFlatMode(!0),this.isControlElement(t.target)||this.dragController.isDraggingActive()||this.compassController.isRotatingActive())return;const e=this.mapView.closest("#map-container");if(!e)return;const i=this.transformController.getZoomStep();this.transformController.zoomAtPoint(this.transformController.getScale()*(1+i),t.clientX,t.clientY,e)}))}isControlElement(t){return t.closest(".map-controls")!==null||t.closest(".compass-container")!==null||t.closest(".map-mode-selector")!==null}}class P{constructor(t){n(this,"mapContainer");this.mapContainer=t}showNotification(t,e=3e3){let i=document.getElementById("map-notification");!i&&this.mapContainer&&(i=document.createElement("div"),i.id="map-notification",i.className="map-notification",this.mapContainer.appendChild(i)),i&&(i.textContent=t,i.classList.add("show"),setTimeout(()=>{i&&i.classList.remove("show")},e))}}var C=(d=>(d.DEFAULT="default",d.DANGER="danger",d))(C||{});const q="http://www.w3.org/1999/xlink";class F{constructor(t,e){n(this,"userPointsGroup",null);n(this,"pointCounter",0);n(this,"currentMarkerType",C.DEFAULT);n(this,"mapSvg");n(this,"notificationController");n(this,"pointPlacementMode",!1);n(this,"newMarkerFormData",{title:"",description:""});n(this,"INFO_MARKER_ICON","./assets/icons/info-marker.svg");n(this,"DANGER_MARKER_ICON","./assets/icons/danger-marker.svg");n(this,"activeTooltip",null);n(this,"tooltipAutoCloseTimer",null);n(this,"mapContainer",null);n(this,"markerFormCallback",null);n(this,"handleMarkerClick",t=>{const e=t.target.closest(".location-marker");if(e){t.stopPropagation();const i=e.getAttribute("data-title")||"Sans titre",r=e.getAttribute("data-description")||"Sans description",s=e.classList.contains("danger")?C.DANGER:C.DEFAULT;this.showTooltip(i,r,s)}});n(this,"handleMarkerFormSubmit",t=>{t.preventDefault();const e=t.target,i=e.querySelector("#marker-title"),r=e.querySelector("#marker-description"),s=e.querySelector("#title-error"),o=e.querySelector("#description-error");let a=!0;if(i.value.trim()?s.style.display="none":(s.style.display="block",a=!1),r.value.trim()?o.style.display="none":(o.style.display="block",a=!1),a&&this.markerFormCallback){this.markerFormCallback({title:i.value.trim(),description:r.value.trim()});const u=document.querySelector(".marker-options");if(u){const l=u.querySelector(".marker-form");l&&u.removeChild(l)}}});n(this,"handleMarkerFormCancel",t=>{t.preventDefault();const e=document.querySelector(".marker-options");e&&e.classList.contains("visible")&&e.classList.remove("visible"),this.pointPlacementMode=!1,this.notificationController.showNotification("Ajout de marqueur annulé."),document.querySelectorAll(".marker-option-btn.active").forEach(r=>r.classList.remove("active")),this.mapSvg&&this.mapSvg.contentDocument&&this.mapSvg.contentDocument.removeEventListener("click",this.handleSvgClickForPointPlacement),document.removeEventListener("click",this.handleOutsideClick),document.dispatchEvent(new CustomEvent("markerPlacementCancelled"))});n(this,"handleOutsideClick",t=>{const e=document.querySelector(".marker-options"),i=document.querySelector(".add-comment-btn");e&&!e.contains(t.target)&&t.target!==i&&e.querySelector(".marker-form")&&this.handleMarkerFormCancel(t)});n(this,"handleSvgClickForPointPlacement",t=>{if(t.stopPropagation(),!this.userPointsGroup&&(this.initializeMarkerGroup(),!this.userPointsGroup))return;const e=this.mapSvg.contentDocument;if(!e)return;const i=e.querySelector("svg");if(!i)return;const r=i.createSVGPoint(),s=i.getScreenCTM();if(s){r.x=t.clientX,r.y=t.clientY;const o=r.matrixTransform(s.inverse());this.pointCounter++;const a=this.createMarker({id:`user-point-${this.pointCounter}`,x:o.x,y:o.y,type:this.currentMarkerType,title:this.newMarkerFormData.title,description:this.newMarkerFormData.description}),u=document.createElementNS("http://www.w3.org/2000/svg","animateTransform");u.setAttribute("attributeName","transform"),u.setAttribute("type","translate"),u.setAttribute("from",`${o.x} ${o.y-30}`),u.setAttribute("to",`${o.x} ${o.y}`),u.setAttribute("dur","0.4s"),u.setAttribute("begin","indefinite"),u.setAttribute("fill","freeze"),u.setAttribute("calcMode","ease-out"),a.appendChild(u),this.userPointsGroup.appendChild(a),setTimeout(()=>{u.beginElement()},10);const l=this.currentMarkerType===C.DANGER?"de danger":"";this.notificationController.showNotification(`Marqueur ${l} "${this.newMarkerFormData.title}" ajouté.`),e.removeEventListener("click",this.handleSvgClickForPointPlacement),document.removeEventListener("click",this.handleOutsideClick),this.pointPlacementMode=!1,this.newMarkerFormData={title:"",description:""};const c=document.querySelector(".marker-options");c&&c.classList.contains("visible")&&(c.classList.remove("visible"),document.querySelectorAll(".marker-option-btn.active").forEach(m=>m.classList.remove("active"))),this.mapSvg&&this.mapSvg.contentDocument&&(this.mapSvg.contentDocument.querySelectorAll("*").forEach(h=>{h.style.pointerEvents=""}),this.mapSvg.style.pointerEvents=""),document.dispatchEvent(new CustomEvent("markerPlaced",{detail:{markerId:a.id}})),this.mapContainer&&this.mapContainer.classList.remove("point-placement-mode")}});this.mapSvg=t,this.notificationController=e,this.mapContainer=document.getElementById("map-container"),this.mapSvg&&(this.mapSvg.addEventListener("load",()=>{this.initializeMarkerGroup()}),setTimeout(()=>{this.mapSvg.contentDocument&&this.mapSvg.contentDocument.readyState==="complete"&&this.initializeMarkerGroup()},100)),document.addEventListener("click",i=>{const r=i.target.closest(".location-marker"),s=i.target.closest(".marker-tooltip"),o=i.target.closest(".marker-form, .marker-options");!r&&!s&&!o&&this.activeTooltip&&this.hideTooltip()})}initializeMarkerGroup(){if(!this.mapSvg||!this.mapSvg.contentDocument)return;const t=this.mapSvg.contentDocument.querySelector("svg");if(t){const e=this.mapSvg.contentDocument.getElementById("user-points-group");e?this.userPointsGroup=e:(this.userPointsGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.userPointsGroup.setAttribute("id","user-points-group"),t.appendChild(this.userPointsGroup)),this.userPointsGroup.addEventListener("click",this.handleMarkerClick),t.addEventListener("click",i=>{!i.target.closest(".location-marker")&&this.activeTooltip&&this.hideTooltip()})}}showTooltip(t,e,i){this.tooltipAutoCloseTimer!==null&&(clearTimeout(this.tooltipAutoCloseTimer),this.tooltipAutoCloseTimer=null),this.activeTooltip&&(this.activeTooltip.remove(),this.activeTooltip=null),this.activeTooltip=document.createElement("div"),this.activeTooltip.className=`marker-tooltip ${i}`,this.activeTooltip.innerHTML=`
      <button class="marker-tooltip-close">&times;</button>
      <div class="marker-tooltip-title">${t}</div>
      <div class="marker-tooltip-description">${e}</div>
    `,document.body.appendChild(this.activeTooltip);const r=this.activeTooltip.querySelector(".marker-tooltip-close");r&&r.addEventListener("click",()=>{this.hideTooltip()}),this.activeTooltip.classList.add("visible"),this.tooltipAutoCloseTimer=window.setTimeout(()=>{this.hideTooltip()},15e3)}hideTooltip(){if(this.activeTooltip){this.tooltipAutoCloseTimer!==null&&(clearTimeout(this.tooltipAutoCloseTimer),this.tooltipAutoCloseTimer=null),this.activeTooltip.classList.add("hiding"),this.activeTooltip.classList.remove("visible");const t=this.activeTooltip;this.activeTooltip=null,setTimeout(()=>{t&&t.parentNode&&t.parentNode.removeChild(t)},300)}}showMarkerForm(t,e){this.newMarkerFormData={title:"",description:""},this.markerFormCallback=e;const i=document.querySelector(".marker-options");if(!i)return;const r=i.querySelector(".marker-form");r&&i.removeChild(r);const s=document.createElement("form");s.className=`marker-form ${t}`,s.innerHTML=`
      <div class="marker-form-field">
        <label for="marker-title">Titre</label>
        <input type="text" id="marker-title" placeholder="Titre du marqueur" required>
        <div class="marker-form-error" id="title-error" style="display: none;">Le titre est requis</div>
      </div>
      
      <div class="marker-form-field">
        <label for="marker-description">Description</label>
        <textarea id="marker-description" placeholder="Description du marqueur" required></textarea>
        <div class="marker-form-error" id="description-error" style="display: none;">La description est requise</div>
      </div>
      
      <div class="marker-form-actions">
        <button type="button" class="marker-form-cancel">Annuler</button>
        <button type="submit" class="marker-form-submit">Placer le marqueur</button>
      </div>
    `,i.appendChild(s),s.addEventListener("submit",this.handleMarkerFormSubmit);const o=s.querySelector(".marker-form-cancel");o&&o.addEventListener("click",this.handleMarkerFormCancel),document.addEventListener("click",this.handleOutsideClick);const a=s.querySelector("#marker-title");a&&a.focus()}setMarkerType(t){this.currentMarkerType=t}setPointPlacementMode(t){this.pointPlacementMode=t,this.mapSvg&&this.mapSvg.contentDocument&&(t?(this.mapSvg.contentDocument.removeEventListener("click",this.handleSvgClickForPointPlacement),this.showMarkerForm(this.currentMarkerType,e=>{this.newMarkerFormData=e,this.mapSvg.contentDocument.addEventListener("click",this.handleSvgClickForPointPlacement),this.notificationController.showNotification("Cliquez sur la carte pour placer le marqueur.")})):(this.mapSvg.contentDocument.removeEventListener("click",this.handleSvgClickForPointPlacement),this.notificationController.showNotification("Mode placement de points désactivé.")))}isPointPlacementModeActive(){return this.pointPlacementMode}createMarker(t){const{id:e,x:i,y:r,type:s,title:o,description:a,color:u}=t,l=document.createElementNS("http://www.w3.org/2000/svg","g");l.setAttribute("id",e),l.setAttribute("class",`location-marker ${s} ${u||""}`),l.setAttribute("transform",`translate(${i}, ${r}) translateZ(1px)`),
    l.setAttribute("style","transform-style: preserve-3d;"),l.setAttribute("data-title",o),l.setAttribute("data-description",a);const c=document.createElementNS("http://www.w3.org/2000/svg","ellipse");c.setAttribute("cx","0"),c.setAttribute("cy","1"),c.setAttribute("rx","4"),c.setAttribute("ry","2"),c.setAttribute("fill","rgba(0, 0, 0, 0.3)"),c.setAttribute("filter","blur(1px)"),l.appendChild(c);const h=document.createElementNS("http://www.w3.org/2000/svg","image");h.setAttribute("width","24"),h.setAttribute("height","24"),h.setAttribute("x","-12"),h.setAttribute("y","-24");const m=s===C.DANGER?this.DANGER_MARKER_ICON:this.INFO_MARKER_ICON;return h.setAttributeNS(q,"href",m),l.appendChild(h),l}clearAllMarkers(){if(this.userPointsGroup){for(;this.userPointsGroup.firstChild;)this.userPointsGroup.removeChild(this.userPointsGroup.firstChild);this.pointCounter=0,this.notificationController.showNotification("Tous les marqueurs ont été supprimés.")}}exportMarkers(){if(!this.userPointsGroup)return"[]";const t=Array.from(this.userPointsGroup.querySelectorAll(".location-marker")).map(e=>{const r=(e.getAttribute("transform")||"").match(/translate\(([^,]+),\s*([^)]+)\)/),s=r?parseFloat(r[1]):0,o=r?parseFloat(r[2]):0,a=e.classList.contains("danger"),u=e.getAttribute("data-title")||"Sans titre",l=e.getAttribute("data-description")||"Sans description";let c="red";return e.classList.contains("blue")&&(c="blue"),e.classList.contains("green")&&(c="green"),e.classList.contains("yellow")&&(c="yellow"),e.classList.contains("purple")&&(c="purple"),{id:e.id,x:s,y:o,type:a?"danger":"default",title:u,description:l,color:c}});return JSON.stringify(t,null,2)}}class z{constructor(t){n(this,"user");this.user=t}render(){const t=document.createElement("div");t.className="user-container";const e=document.createElement("span");e.className="user-color-dot",e.style.backgroundColor=this.user.color||"#888";const i=document.createElement("span");i.className="user-name",i.textContent=this.user.name,this.user.isCurrentUser&&(i.textContent+=" (vous)");const r=document.createElement("span");return r.className="user-location",this.user.position?r.textContent=`(${this.user.position.x}, ${this.user.position.y})`:r.textContent="(localisation inconnue)",t.appendChild(e),t.appendChild(i),t}}class H{constructor(t,e=[]){n(this,"container");n(this,"users",[]);n(this,"userContainers",[]);this.container=t,this.users=e,this.setupUserList()}updateUsers(t){this.hideUserOnMap(),this.users=t,this.clearUserContainers(),this.setupUserList()}clearUserContainers(){this.userContainers.forEach(e=>{const i=e.render();i&&this.container.contains(i)&&this.container.removeChild(i)});const t=document.querySelector(".users-container");t&&this.container.removeChild(t),this.userContainers=[]}setupUserList(){const t=document.createElement("div");t.className="users-container";const e=document.createElement("div");e.className="user-list",this.users.forEach(i=>{this.displayUserOnMap(i);const r=new z(i);this.userContainers.push(r),e.appendChild(r.render())}),t.appendChild(e),this.container.appendChild(t)}addUserOnMap(t){const e=document.getElementById("map-svg"),i=e==null?void 0:e.contentDocument,r=i==null?void 0:i.createElementNS("http://www.w3.org/2000/svg","path");r==null||r.setAttribute("class",t.id),r==null||r.setAttribute("style",`display:none;stroke:white;stroke-width:0.4;fill-rule:nonzero;fill:${t.color};fill-opacity:1;`),r==null||r.setAttribute("d",this.calculatePath(t)),console.log(e);const s=i==null?void 0:i.querySelector("svg");s==null||s.appendChild(r)}calculatePath(t){var o,a,u,l;const e=[[-.890625,3.023438],[-2.382813,2.070312],[-3.125,.445313],[-2.867187,-1.3125],[-1.710938,-2.648438],[0,-3.15625],[1.710938,-2.65625],[2.867187,-1.3125],[3.125,.453125],[2.382813,2.0625],[.890625,3.03125]];let i=(o=t.position)==null?void 0:o.x,r=(a=t.position)==null?void 0:a.y,s=`M ${i} ${r}`;for(const[c,h]of e)i+=c,r+=h,s+=` L ${i} ${r}`;return s+=` L ${(u=t.position)==null?void 0:u.x} ${(l=t.position)==null?void 0:l.y}`,s}displayUserOnMap(t){var s,o,a;this.addUserOnMap(t);const i=(o=(s=document.getElementById("map-svg").contentDocument)==null?void 0:s.querySelector("svg"))==null?void 0:o.querySelector(`path.${t.id}`);var r=(a=i==null?void 0:i.getAttribute("style"))==null?void 0:a.replace("display: none;","display:initial;").replace("display:none;","display:initial;");i==null||i.setAttribute("style",r)}hideUserOnMap(){var e,i,r;for(const s of["user1","user2"]){const a=(i=(e=document.getElementById("map-svg").contentDocument)==null?void 0:e.querySelector("svg"))==null?void 0:i.querySelector(`path.${s}`);var t=(r=a==null?void 0:a.getAttribute("style"))==null?void 0:r.replace("display: initial;","display:none;").replace("display:initial;","display:none;");a==null||a.setAttribute("style",t)}}}const G="ws://localhost:8080",$=[{id:"user1",name:"Léo",color:"rgb(66,133,244)",location:{latitude:388.88,longitude:735.08}},{id:"user2",name:"Zineddine",color:"rgb(244,66,66)",location:{latitude:160.585938,longitude:314.890625}},{id:"user3",name:"Youcef",color:"rgb(244,244,66)",location:{latitude:307.804688,longitude:416.132812}}],y=class y{constructor(){n(this,"ws",null);n(this,"users",[]);this.initWebSocketClient()}static getInstance(){return y.instance||(y.instance=new y),y.instance}async getUsers(){var t;return(t=this.ws)==null||t.send("status"),await new Promise(e=>setTimeout(e,100)),this.users}initWebSocketClient(){this.ws=new WebSocket(G),window.addEventListener("beforeunload",()=>{var t;this.users.length>0&&this.users.forEach(e=>{var i;e.isCurrentUser&&((i=this.ws)==null||i.send(`${e.id} disconnected`))}),(t=this.ws)==null||t.close()}),this.ws.onopen=()=>{console.log("Connecté au serveur WebSocket")},this.ws.onmessage=t=>{var r;console.log(t.data);let e=JSON.parse(t.data),i="";for(let s=0;s<e.length;s++)if(e[s].isCurrent){i=e[s].id;break}i?((r=this.ws)==null||r.send(`${i} is connected`),this.registerUser(i)):this.updateUserConnections(e)}}registerUser(t){const e=$.find(i=>i.id===t);if(e){let i=!1;this.users.length==0&&(i=!0),this.users.push({id:e.id,name:e.name,color:e.color,position:{x:e.location.latitude,y:e.location.longitude},isCurrentUser:i})}}updateUserConnections(t){if(t.length>this.users.length)for(let e=0;e<t.length;e++)this.users.map(i=>i.id).includes(t[e].id)||this.registerUser(t[e].id);else for(let e=0;e<this.users.length;e++)t.map(i=>i.id).includes(this.users[e].id)||this.users.splice(e,1)}};n(y,"instance",null);let M=y;class j{constructor(){n(this,"bubble");n(this,"userList",null);this.bubble=document.createElement("div"),this.bubble.className="user-bubble";const t=document.createElement("div");t.className="user-bubble-title",t.textContent="Utilisateurs connectés",this.bubble.appendChild(t);const e=document.createElement("div");e.className="user-bubble-list",this.bubble.appendChild(e);const i=document.getElementById("map-container"),r=i==null?void 0:i.querySelector(".map-controls");i&&r?i.insertBefore(this.bubble,r):document.body.appendChild(this.bubble),e.innerHTML="",this.userList=new H(e,[]),this.loadUsers(e),setInterval(()=>this.loadUsers(e),4e3)}async loadUsers(t){var r;const e=M.getInstance();await new Promise(s=>setTimeout(s,1e3));const i=await e.getUsers();t.innerHTML="",(r=this.userList)==null||r.updateUsers(i)}}var f=(d=>(d.VIEW="view",d.CREATE="create",d))(f||{}),A=(d=>(d[d.EASY=1]="EASY",d[d.MEDIUM=2]="MEDIUM",d[d.HARD=3]="HARD",d))(A||{}),b=(d=>(d.HIKING="Randonnée pédestre",d.SPORTY_HIKE="Randonnée sportive",d.EASY_WALK="Balade tranquille",d.TRAIL_RUNNING="Trail running",d.FAMILY_WALK="Promenade familiale",d.MOUNTAIN_BIKE="VTT",d.ROAD_BIKE="Vélo de route",d))(b||{});class V{constructor(t,e){n(this,"mapSvg");n(this,"notificationController");n(this,"editorMode",f.VIEW);n(this,"currentTrail",null);n(this,"editorContainer",null);n(this,"startTrailCreation",()=>{console.log("Démarrage de la création d'un nouveau parcours"),this.currentTrail={id:`trail-${Date.now()}`,name:"",description:"",color:"#3366CC",svgElements:[],isComplete:!1,difficulty:A.EASY,type:b.HIKING},this.editorMode=f.CREATE,this.editorContainer&&this.editorContainer.classList.add("visible");const t=document.getElementById("map-container");t?t.classList.add("trail-creation-mode"):document.body.classList.add("trail-creation-mode"),this.notificationController.showNotification("Sélectionnez des éléments sur la carte pour créer votre parcours."),console.log("Émission de l'événement trailCreationStarted"),document.dispatchEvent(new CustomEvent("trailCreationStarted"))});n(this,"cancelTrailCreation",()=>{this.currentTrail&&(this.currentTrail.svgElements.length>0&&!confirm("Êtes-vous sûr de vouloir annuler la création de ce parcours ?")||(this.deselectAllSvgElements(),this.currentTrail=null,this.editorMode=f.VIEW,this.closeEditor(),document.dispatchEvent(new CustomEvent("trailCreationCancelled"))))});n(this,"closeEditor",()=>{var e;this.editorContainer&&this.editorContainer.classList.remove("visible");const t=document.getElementById("map-container");if(t?t.classList.remove("trail-creation-mode"):document.body.classList.remove("trail-creation-mode"),
      this.currentTrail&&this.currentTrail.svgElements.length>0&&!this.currentTrail.isComplete&&this.deselectAllSvgElements(),this.editorContainer&&!((e=this.currentTrail)!=null&&e.isComplete)){const i=this.editorContainer.querySelector("#trail-name");i&&(i.value="");const r=this.editorContainer.querySelector(".trail-editor-point-count"),s=this.editorContainer.querySelector(".trail-editor-distance");r&&(r.textContent="0"),s&&(s.textContent="0 m")}this.currentTrail&&!this.currentTrail.isComplete&&(this.currentTrail=null,this.editorMode=f.VIEW,document.dispatchEvent(new CustomEvent("trailCreationCancelled")),console.log("Mode de création de parcours désactivé"))});n(this,"finishTrail",()=>{if(!this.currentTrail)return;if(this.currentTrail.svgElements.length<2){alert("Un parcours doit avoir au moins 2 éléments SVG sélectionnés.");return}if(this.editorContainer){const r=this.editorContainer.querySelector("#trail-name"),s=this.editorContainer.querySelector("#trail-difficulty"),o=this.editorContainer.querySelector("#trail-type"),a=this.editorContainer.querySelector("#trail-name-error");let u=!0;if(!r||!r.value.trim()?(a&&(a.style.display="block"),u=!1):a&&(a.style.display="none"),!u)return;if(this.currentTrail.name=r.value.trim(),this.currentTrail.description="",s){const l=parseInt(s.value,10);this.currentTrail.difficulty=l}o&&(this.currentTrail.type=o.value)}this.currentTrail.isComplete=!0,this.currentTrail.distance=this.calculateTrailDistance(),this.saveTrail(this.currentTrail),this.deselectAllSvgElements(),this.notificationController.showNotification(`Parcours "${this.currentTrail.name}" créé avec succès avec ${this.currentTrail.svgElements.length} éléments.`);const t="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgdmlld0JveD0iMCAwIDgwIDgwIiBmaWxsPSJub25lIj48cmVjdCB3aWR0aD0iODAiIGhlaWdodD0iODAiIGZpbGw9IiMxMTFjMjkiLz48cGF0aCBkPSJNNDAgMjBMMjkgNDVINTFMNDAgMjBaIiBmaWxsPSIjMTRjNzhiIi8+PHBhdGggZD0iTTI1IDUwQzI1IDQ3LjIzODYgMjcuMjM4NiA0NSAzMCA0NUgzN1Y2MEgyNVY1MFoiIGZpbGw9IiMzMzQxNTUiLz48cGF0aCBkPSJNNTUgNTBDNTUgNDcuMjM4NiA1Mi43NjE0IDQ1IDUwIDQ1SDQzVjYwSDU1VjUwWiIgZmlsbD0iIzMzNDE1NSIvPjwvc3ZnPg==",e=this.currentTrail.svgElements.map(r=>{const s={id:r.id,type:r.type,order:r.order};return"d"in r&&(s.d=r.d),"points"in r&&(s.points=r.points),"cx"in r&&(s.cx=r.cx,s.cy=r.cy,s.r=r.r),"x"in r&&(s.x=r.x,s.y=r.y,s.width=r.width,s.height=r.height),s});console.log("Éléments SVG pour le parcours (avec attributs géométriques):",e);const i={id:this.currentTrail.id,name:this.currentTrail.name,difficulty:this.currentTrail.difficulty,distance:this.currentTrail.distance/1e3,type:this.currentTrail.type,image:t,svgElements:e};this.currentTrail=null,this.editorMode=f.VIEW,this.closeEditor(),document.dispatchEvent(new CustomEvent("trailCreationFinished",{detail:{trail:i}}))});n(this,"handleKeyDown",t=>{t.key==="Escape"&&this.editorMode===f.CREATE&&(console.log("Touche Escape pressée en mode création, fermeture de l'éditeur"),this.setTrailEditorMode(!1))});this.mapSvg=t,this.notificationController=e,this.createEditorUI(),console.log("TrailEditorController initialisé, configuration de l'écouteur d'événements"),document.addEventListener("svgElementSelectedForTrail",i=>{const r=i;console.log("Événement svgElementSelectedForTrail reçu:",r.detail),this.handleSvgElementSelected(r.detail.element)}),document.addEventListener("keydown",this.handleKeyDown)}handleSvgElementSelected(t){if((this.editorMode!==f.CREATE||!this.currentTrail)&&this.startTrailCreation(),!this.currentTrail){console.error("Impossible de créer un parcours, annulation de la sélection");return}console.log("Traitement de la sélection d'élément SVG:",t.id,t.type);const e=t.element.hasAttribute("data-selected-for-trail");if(console.log("Élément déjà sélectionné?",e),e){console.log("Suppression de l'élément du parcours");const i=this.currentTrail.svgElements.findIndex(r=>r.id===t.id&&r.type===t.type);i!==-1&&(this.currentTrail.svgElements.splice(i,1),this.currentTrail.svgElements.forEach((r,s)=>{r.order=s})),this.removeSelectionEffect(t.element),this.notificationController.showNotification(`Élément #${t.id} retiré du parcours`)}else{console.log("Ajout de l'élément au parcours");const i={id:t.id,type:t.type,order:this.currentTrail.svgElements.length},r=t.element;r.hasAttribute("d")&&(i.d=r.getAttribute("d")),r.hasAttribute("points")&&(i.points=r.getAttribute("points")),r.hasAttribute("cx")&&(i.cx=r.getAttribute("cx"),i.cy=r.getAttribute("cy"),i.r=r.getAttribute("r")),r.hasAttribute("x")&&(i.x=r.getAttribute("x"),i.y=r.getAttribute("y"),i.width=r.getAttribute("width"),i.height=r.getAttribute("height")),this.currentTrail.svgElements.push(i),this.applySelectionEffect(t.element),this.currentTrail.svgElements.length===1?this.notificationController.showNotification("Premier élément sélectionné. Continuez à sélectionner des éléments pour créer votre parcours."):this.notificationController.showNotification(`Élément #${t.id} ajouté au parcours (total: ${this.currentTrail.svgElements.length})`)}console.log("État actuel du parcours:",{id:this.currentTrail.id,nbElements:this.currentTrail.svgElements.length,elements:this.currentTrail.svgElements.map(i=>({...i}))}),this.updateEditorInfo()}applySelectionEffect(t){if(!this.mapSvg.contentDocument)return;t.setAttribute("data-selected-for-trail","true");const e=this.mapSvg.contentDocument.getElementById("highlight-layer");if(!e){console.error("Le groupe de surbrillance n'existe pas");return}const i=t.id||t.tagName.toLowerCase()+"-"+Math.random().toString(36).substr(2,9),r=`selected-${i}-${Math.random().toString(36).substr(2,9)}`,s=document.createElementNS("http://www.w3.org/2000/svg",t.tagName);s.setAttribute("id",r),s.setAttribute("class","selected-element"),t.hasAttribute("d")&&s.setAttribute("d",t.getAttribute("d")||""),t.hasAttribute("points")&&s.setAttribute("points",t.getAttribute("points")||""),t.hasAttribute("cx")&&(s.setAttribute("cx",t.getAttribute("cx")||""),s.setAttribute("cy",t.getAttribute("cy")||""),s.setAttribute("r",t.getAttribute("r")||"")),t.hasAttribute("x")&&(s.setAttribute("x",t.getAttribute("x")||""),s.setAttribute("y",t.getAttribute("y")||""),s.setAttribute("width",t.getAttribute("width")||""),s.setAttribute("height",t.getAttribute("height")||"")),s.setAttribute("data-source-id",i),e.appendChild(s),t.setAttribute("data-selection-highlight-id",s.id),s.setAttribute("stroke","#3366CC")}removeSelectionEffect(t){if(!this.mapSvg.contentDocument)return;const e=this.mapSvg.contentDocument.getElementById("highlight-layer");if(!e){console.error("Le groupe de surbrillance n'existe pas");return}const i=t.getAttribute("data-selection-highlight-id");if(console.log(`DÉSÉLECTION ÉLÉMENT ${t.tagName}#${t.id||"sans-id"} - highlight ID:`,i),i){const r=this.mapSvg.contentDocument.getElementById(i);r&&e.removeChild(r)}t.removeAttribute("data-selected-for-trail"),t.removeAttribute("data-selection-highlight-id")}deselectAllSvgElements(){if(!this.mapSvg.contentDocument)return;const t=this.mapSvg.contentDocument.querySelectorAll('[data-selected-for-trail="true"]');console.log(`DÉSÉLECTION DE ${t.length} ÉLÉMENTS SVG`),t.forEach(e=>{this.removeSelectionEffect(e)})}createEditorUI(){this.editorContainer=document.createElement("div"),this.editorContainer.className="trail-editor-container",this.editorContainer.innerHTML=`
      <div class="trail-editor-header">
        <h3>Créer un nouveau parcours</h3>
        <button class="trail-editor-close">&times;</button>
      </div>
      <div class="trail-editor-body">
        <form class="trail-editor-form">
          <div class="trail-editor-field">
            <label for="trail-name">Nom du parcours</label>
            <input type="text" id="trail-name" placeholder="Nom du parcours" required>
            <div class="marker-form-error" id="trail-name-error" style="display: none;">Le nom est requis</div>
          </div>
          
          <div class="trail-editor-field">
            <label for="trail-difficulty">Difficulté</label>
            <select id="trail-difficulty" required>
              <option value="${A.EASY}">Facile</option>
              <option value="${A.MEDIUM}">Modéré</option>
              <option value="${A.HARD}">Difficile</option>
            </select>
          </div>
          
          <div class="trail-editor-field">
            <label for="trail-type">Type de parcours</label>
            <select id="trail-type" required>
              <option value="${b.HIKING}">Randonnée pédestre</option>
              <option value="${b.SPORTY_HIKE}">Randonnée sportive</option>
              <option value="${b.EASY_WALK}">Balade tranquille</option>
              <option value="${b.TRAIL_RUNNING}">Trail running</option>
              <option value="${b.FAMILY_WALK}">Promenade familiale</option>
              <option value="${b.MOUNTAIN_BIKE}">VTT</option>
              <option value="${b.ROAD_BIKE}">Vélo de route</option>
            </select>
          </div>
          
          <div class="trail-editor-info">
            <p>Éléments sélectionnés: <span class="trail-editor-point-count">0</span></p>
            <p>Distance estimée: <span class="trail-editor-distance">0 m</span></p>
          </div>
          
          <div class="trail-editor-instructions">
            <p>Sélectionnez des éléments sur la carte pour créer votre parcours.</p>
            <p>Un parcours doit contenir au moins 2 éléments.</p>
          </div>
        </form>
      </div>
      <div class="trail-editor-footer">
        <button class="trail-editor-btn cancel">Annuler</button>
        <button class="trail-editor-btn finish primary">Enregistrer</button>
      </div>
    `;const t=document.getElementById("map-container");t?t.appendChild(this.editorContainer):(document.body.appendChild(this.editorContainer),console.warn("Le conteneur de la carte n'a pas été trouvé. L'éditeur de parcours sera ajouté au body."));const e=this.editorContainer.querySelector(".trail-editor-close"),i=this.editorContainer.querySelector(".trail-editor-btn.cancel"),r=this.editorContainer.querySelector(".trail-editor-btn.finish");e&&e.addEventListener("click",this.closeEditor),i&&i.addEventListener("click",this.cancelTrailCreation),r&&r.addEventListener("click",this.finishTrail)}updateEditorInfo(){if(!this.editorContainer||!this.currentTrail)return;const t=this.editorContainer.querySelector(".trail-editor-point-count"),e=this.editorContainer.querySelector(".trail-editor-distance");if(t&&(t.textContent=this.currentTrail.svgElements.length.toString()),e){const i=this.calculateTrailDistance();e.textContent=i<1e3?`${Math.round(i)} m`:`${(i/1e3).toFixed(2)} km`}}calculateTrailDistance(){return this.currentTrail?this.currentTrail.svgElements.length*100:0}saveTrail(t){const e=localStorage.getItem("map_trails")||"[]",i=JSON.parse(e),r={...t,svgElements:t.svgElements.map(s=>{const o={id:s.id,type:s.type,order:s.order};if(s.element){const a=s.element;a.hasAttribute("d")&&(o.d=a.getAttribute("d")),a.hasAttribute("points")&&(o.points=a.getAttribute("points")),a.hasAttribute("cx")&&(o.cx=a.getAttribute("cx"),o.cy=a.getAttribute("cy"),o.r=a.getAttribute("r")),a.hasAttribute("x")&&(o.x=a.getAttribute("x"),o.y=a.getAttribute("y"),o.width=a.getAttribute("width"),o.height=a.getAttribute("height"))}else"d"in s&&(o.d=s.d),"points"in s&&(o.points=s.points),"cx"in s&&(o.cx=s.cx,o.cy=s.cy,o.r=s.r),"x"in s&&(o.x=s.x,o.y=s.y,o.width=s.width,o.height=s.height);return o})};i.push(r),localStorage.setItem("map_trails",JSON.stringify(i)),console.log("Parcours sauvegardé avec attributs géométriques:",r)}setTrailEditorMode(t){if(t)this.startTrailCreation();else{if(this.editorMode===f.VIEW)return;this.closeEditor(),this.currentTrail&&!this.currentTrail.isComplete&&(this.deselectAllSvgElements(),this.currentTrail=null,this.editorMode=f.VIEW,document.dispatchEvent(new CustomEvent("trailCreationCancelled")))}}isTrailEditorModeActive(){return this.editorMode===f.CREATE}highlightTrail(t){if(console.log("Mise en surbrillance du parcours:",t.id),!this.mapSvg){console.error("Document SVG non disponible");return}const e=()=>{if(this.clearAllHighlights(),!this.mapSvg.contentDocument){console.error("Document SVG non disponible");return}if(!t.svgElements||!Array.isArray(t.svgElements)){console.warn("Aucun élément SVG trouvé dans le parcours");return}console.log("Éléments SVG du parcours à mettre en surbrillance:",t.svgElements);const i=document.getElementById("map-container");i&&!i.classList.contains("mode-grabbing")&&(i.classList.remove("mode-grabbing","mode-trail-creation"),i.classList.add("mode-flat"));const r=this.mapSvg.contentDocument;let s=r.getElementById("highlight-layer");if(!s){const a=r.querySelector("svg");if(!a){console.error("Élément SVG racine non trouvé");return}s=document.createElementNS("http://www.w3.org/2000/svg","g"),s.setAttribute("id","highlight-layer"),s.setAttribute("class","highlight-layer"),s.setAttribute("pointer-events","none");const u=document.createElementNS("http://www.w3.org/2000/svg","style");u.textContent=`
          .trail-highlight-element {
            stroke: #FF5722;
            stroke-width: 3px;
            fill: none;
            filter: drop-shadow(0 0 3px rgba(255, 87, 34, 0.5));
            pointer-events: none;
            opacity: 0.8;
            z-index: 1000;
          }
        `,a.appendChild(u),a.appendChild(s)}this.mapSvg.style.pointerEvents="auto";let o=0;t.svgElements.forEach(a=>{var p;const u=((p=a.type)==null?void 0:p.toLowerCase())||"path",l=a.id;console.log(`Création de surbrillance pour l'élément ${u}#${l}`,a);const c=document.createElementNS("http://www.w3.org/2000/svg",u),h=`trail-highlight-${l}-${Math.random().toString(36).substr(2,9)}`;c.setAttribute("id",h),c.setAttribute("class","trail-highlight-element"),c.setAttribute("data-trail-id",t.id);let m=!1;if(a.d&&(c.setAttribute("d",a.d),m=!0),a.points&&(c.setAttribute("points",a.points),m=!0),a.cx!=null&&(c.setAttribute("cx",a.cx),c.setAttribute("cy",a.cy),c.setAttribute("r",a.r),m=!0),a.x!=null&&(c.setAttribute("x",a.x),c.setAttribute("y",a.y),c.setAttribute("width",a.width),c.setAttribute("height",a.height),m=!0),!m){const g=r.getElementById(l);if(!g){console.warn(`Élément SVG avec ID "${l}" non trouvé et pas d'attributs géométriques disponibles`);return}g.hasAttribute("d")&&c.setAttribute("d",g.getAttribute("d")||""),g.hasAttribute("points")&&c.setAttribute("points",g.getAttribute("points")||""),g.hasAttribute("cx")&&(c.setAttribute("cx",g.getAttribute("cx")||""),c.setAttribute("cy",g.getAttribute("cy")||""),c.setAttribute("r",g.getAttribute("r")||"")),g.hasAttribute("x")&&(c.setAttribute("x",g.getAttribute("x")||""),c.setAttribute("y",g.getAttribute("y")||""),c.setAttribute("width",g.getAttribute("width")||""),c.setAttribute("height",g.getAttribute("height")||""));const E=g.getAttribute("data-trail-highlights")||"",S=E?`${E},${h}`:h;g.setAttribute("data-trail-highlights",S)}c.style.display="block",c.style.visibility="visible",s.appendChild(c),o++}),console.log(`${o} éléments mis en surbrillance pour le parcours ${t.name}`),o>0?this.notificationController.showNotification(`Parcours "${t.name}" mis en évidence sur la carte (${o} éléments).`):this.notificationController.showNotification(`Impossible de mettre en évidence le parcours "${t.name}". Aucun élément trouvé.`)};if(this.mapSvg.contentDocument&&this.mapSvg.contentDocument.readyState==="complete")e();else{const i=()=>{this.mapSvg.contentDocument&&this.mapSvg.contentDocument.readyState==="complete"?e():setTimeout(i,100)};setTimeout(i,100)}}clearAllHighlights(){if(!this.mapSvg||!this.mapSvg.contentDocument)return;const t=this.mapSvg.contentDocument,e=t.querySelectorAll(".trail-highlight-element");console.log(`Suppression de ${e.length} éléments de surbrillance`),e.forEach(r=>{r.parentNode&&r.parentNode.removeChild(r)}),t.querySelectorAll("[data-trail-highlights]").forEach(r=>{r.removeAttribute("data-trail-highlights")})}}var v=(d=>(d.GRABBING="grabbing",d.FLAT="flat",d.TRAIL_CREATION="trail_creation",d))(v||{});class O{constructor(){n(this,"transformController");n(this,"dragController");n(this,"compassController");n(this,"uiController");n(this,"notificationController");n(this,"markerController");n(this,"trailEditorController");n(this,"mapContainer",null);n(this,"mapView",null);n(this,"mapSvg",null);n(this,"displayMode","grabbing");document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.initialize()):this.initialize()}initialize(){this.mapContainer=document.getElementById("map-container"),this.mapView=document.querySelector(".map-view"),this.mapSvg=document.getElementById("map-svg"),!(!this.mapContainer||!this.mapView||!this.mapSvg)&&(this.transformController=new N(this.mapSvg),this.dragController=new x(this.mapView,this.transformController),this.compassController=new B(this.transformController),this.uiController=new R(this.mapView,this.transformController,this.compassController,this.dragController),this.notificationController=new P(this.mapContainer),this.markerController=new F(this.mapSvg,this.notificationController),this.trailEditorController=new V(this.mapSvg,this.notificationController),new j,this.setupEventListeners(),this.mapSvg&&(this.mapSvg.addEventListener("load",()=>{this.compassController.updateCompassHandle(),this.compassController.updateDirectionIndicator(),this.setupSvgElementsEventListeners(),this.addPlacePointButton(),setTimeout(()=>{this.showHelpTips()},1e3)}),setTimeout(()=>{this.compassController.updateCompassHandle(),this.compassController.updateDirectionIndicator()},100)),this.addModeSelector(),document.addEventListener("markerPlaced",()=>{this.restoreNavigation()}),document.addEventListener("markerPlacementCancelled",()=>{this.restoreNavigation()}),document.addEventListener("trailCreationStarted",()=>{this.setDisplayMode("trail_creation")}),document.addEventListener("trailCreationFinished",()=>{this.restoreNavigation()}),document.addEventListener("trailCreationCancelled",()=>{this.restoreNavigation()}))}setupEventListeners(){this.uiController.setupEventListeners(),this.dragController.setupEventListeners(),this.compassController.setupEventListeners(),window.addEventListener("resize",()=>{}),document.addEventListener("trailCreationCancelled",()=>{console.log("Événement trailCreationCancelled reçu, restauration de la navigation");const t=document.querySelector(".mode-btn.mode-navigation"),e=document.querySelector(".mode-btn.mode-trail-creation");t&&e&&(t.classList.add("active"),e.classList.remove("active")),this.restoreNavigation()})}setupSvgElementsEventListeners(){if(!this.mapSvg)return;const t=this.mapSvg.contentDocument;if(!t)return;console.log("Initialisation des événements SVG - document chargé");const e=t.querySelector("svg");if(!e)return;let i=t.getElementById("highlight-layer");if(!i){i=document.createElementNS("http://www.w3.org/2000/svg","g"),i.setAttribute("id","highlight-layer"),i.setAttribute("class","highlight-layer"),i.setAttribute("pointer-events","none"),e.appendChild(i);const l=document.createElementNS("http://www.w3.org/2000/svg","style");l.textContent=`
        .highlight-element {
          stroke: #3366CC;
          stroke-width: 3px;
          fill: none;
          filter: drop-shadow(0 0 3px rgba(51, 102, 204, 0.5));
          pointer-events: none;
          opacity: 0.7;
        }
        .selected-element {
          stroke: #FF5722;
          stroke-width: 3px;
          stroke-dasharray: 5,3;
          fill: none;
          pointer-events: none;
          opacity: 0.8;
        }
      `,e.appendChild(l)}if(!i){console.error("Impossible de créer ou trouver le groupe de surbrillance");return}const r=(l,c=!1)=>{const h=l.id||"",m=c?`selected-${h||l.tagName.toLowerCase()}-${Math.random().toString(36).substr(2,9)}`:`highlight-${h||l.tagName.toLowerCase()}-${Math.random().toString(36).substr(2,9)}`,p=document.createElementNS("http://www.w3.org/2000/svg",l.tagName);return p.setAttribute("id",m),p.setAttribute("class",c?"selected-element":"highlight-element"),l.hasAttribute("d")&&p.setAttribute("d",l.getAttribute("d")||""),l.hasAttribute("points")&&p.setAttribute("points",l.getAttribute("points")||""),l.hasAttribute("cx")&&(p.setAttribute("cx",l.getAttribute("cx")||""),p.setAttribute("cy",l.getAttribute("cy")||""),p.setAttribute("r",l.getAttribute("r")||"")),l.hasAttribute("x")&&(p.setAttribute("x",l.getAttribute("x")||""),p.setAttribute("y",l.getAttribute("y")||""),p.setAttribute("width",l.getAttribute("width")||""),p.setAttribute("height",l.getAttribute("height")||"")),p.setAttribute("data-source-id",h),p},s=(l,c)=>{if(c){if(l.getAttribute("data-hover-highlight-id"))return;const m=r(l);i.appendChild(m),l.setAttribute("data-hover-highlight-id",m.id)}else{const h=l.getAttribute("data-hover-highlight-id");if(h){const m=t.getElementById(h);m&&i&&i.removeChild(m),l.removeAttribute("data-hover-highlight-id")}}},o=l=>{if(l.getAttribute("fill-rule")==="evenodd")return!0;const h=l.getAttribute("style")||"";return h.includes("fill-rule:evenodd")||h.includes("fill-rule: evenodd")},a=l=>{if(l.tagName.toLowerCase()==="svg"||l.tagName.toLowerCase()==="g"&&!l.getAttribute("id"))return!0;const c=l.getAttribute("id")||"",h=l.getAttribute("class")||"";if(c.includes("background")||c.includes("fond")||c.includes("container")||c.includes("main")||c.includes("map")||h.includes("background")||h.includes("container")||h.includes("map-area")||h.includes("main"))return!0;if(l.tagName.toLowerCase()==="rect"){const m=t.querySelector("svg");if(m){const p=parseFloat(m.getAttribute("width")||"1000"),g=parseFloat(m.getAttribute("height")||"1000"),E=parseFloat(l.getAttribute("width")||"0"),S=parseFloat(l.getAttribute("height")||"0"),L=p*g;if(E*S>.8*L)return!0;const w=parseFloat(l.getAttribute("x")||"0"),I=parseFloat(l.getAttribute("y")||"0");if(w===0&&I===0&&E>.5*p&&S>.5*g)return!0}}return!1},u=t.querySelectorAll("path, rect, circle, polygon, polyline");console.log("Nombre d'éléments SVG trouvés:",u.length),u.forEach(l=>{if(o(l)){l.style.pointerEvents="none";return}if(a(l)){l.style.pointerEvents="none";return}l.style.pointerEvents="auto",l.addEventListener("mouseenter",c=>{c.target===l&&this.displayMode==="trail_creation"&&s(l,!0)}),l.addEventListener("mouseleave",c=>{c.target===l&&this.displayMode==="trail_creation"&&s(l,!1)}),l.addEventListener("click",c=>{if(c.target===l){if(this.displayMode==="flat"){c.stopPropagation();const h=l.id||"sans-id",m=l.tagName;this.notificationController.showNotification(`Élément ${m}#${h} sélectionné`)}else if(this.displayMode==="trail_creation"){c.stopPropagation();const h=l.id||"sans-id",m=l.tagName,p={id:h,type:m,element:l};document.dispatchEvent(new CustomEvent("svgElementSelectedForTrail",{detail:{element:p}}))}}})}),t.addEventListener("mouseenter",l=>{(l.target===t||a(l.target))&&i.querySelectorAll(".highlight-element").forEach(h=>{i.removeChild(h)})})}addPlacePointButton(){const t=document.createElement("div");t.className="comments-toolbar";const e=document.createElement("button");e.className="add-comment-btn",e.title="Ajouter un commentaire",e.innerHTML='<i class="fas fa-comment-alt"></i>',document.querySelector('link[href*="font-awesome"]')||(e.innerHTML="💬");const i=document.createElement("div");i.className="marker-options";const r=document.createElement("div");r.className="marker-options-title",r.textContent="Ajouter un commentaire",i.appendChild(r);const s=document.createElement("button");s.className="marker-option-btn marker-option-info",s.title="Ajouter un point d'information sur la carte",s.innerHTML=`
      <div class="marker-option-icon">
        <i class="fas fa-map-marker-alt"></i>
      </div>
      <div class="marker-option-label">
        Information
      </div>
    `,document.querySelector('link[href*="font-awesome"]')||(s.innerHTML=`
        <div class="marker-option-icon">
          📍
        </div>
        <div class="marker-option-label">
          Information
        </div>
      `);const o=document.createElement("button");o.className="marker-option-btn marker-option-danger",o.title="Ajouter un point de danger sur la carte",o.innerHTML=`
      <div class="marker-option-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="marker-option-label">
        Danger
      </div>
    `,document.querySelector('link[href*="font-awesome"]')||(o.innerHTML=`
        <div class="marker-option-icon">
          ⚠️
        </div>
        <div class="marker-option-label">
          Danger
        </div>
      `),i.appendChild(s),i.appendChild(o),e.addEventListener("click",()=>{i.classList.toggle("visible"),i.classList.contains("visible")||(s.classList.remove("active"),o.classList.remove("active"),this.setPointPlacementMode(!1))}),s.addEventListener("click",()=>{const a=s.classList.contains("active");s.classList.remove("active"),o.classList.remove("active"),a?this.setPointPlacementMode(!1):(s.classList.add("active"),this.markerController.setMarkerType(C.DEFAULT),this.setPointPlacementMode(!0))}),o.addEventListener("click",()=>{const a=o.classList.contains("active");s.classList.remove("active"),o.classList.remove("active"),a?this.setPointPlacementMode(!1):(o.classList.add("active"),this.markerController.setMarkerType(C.DANGER),this.setPointPlacementMode(!0))}),t.appendChild(i),t.appendChild(e),this.mapContainer&&this.mapContainer.appendChild(t),document.addEventListener("click",a=>{i.classList.contains("visible")&&!i.contains(a.target)&&a.target!==e&&i.classList.remove("visible")})}addModeSelector(){if(!this.mapContainer)return;const t=document.createElement("div");t.className="map-mode-switcher";const e=document.createElement("button");e.className="mode-btn mode-navigation active",e.title="Mode navigation - Permet de déplacer, zoomer et pivoter la carte",e.innerHTML=`
      <img src="./assets/icons/hand-cursor.svg" alt="Main" class="mode-icon" />
      <span>Navigation</span>
    `;const i=document.createElement("button");i.className="mode-btn mode-interaction",i.title="Mode interaction - Permet d'interagir avec les éléments de la carte",i.innerHTML=`
      <img src="./assets/icons/pointer-cursor.svg" alt="Curseur" class="mode-icon" />
      <span>Interaction</span>
    `;const r=document.createElement("button");r.className="mode-btn mode-trail-creation",r.title="Mode création de parcours - Permet de créer un parcours en sélectionnant des éléments",r.innerHTML=`
      <img src="./assets/icons/trail-run.svg" alt="Parcours" class="mode-icon" />
      <span>Créer parcours</span>
    `,t.appendChild(e),t.appendChild(i),t.appendChild(r),this.mapContainer.appendChild(t),e.addEventListener("click",()=>{e.classList.contains("active")||(this.trailEditorController.setTrailEditorMode(!1),e.classList.add("active"),i.classList.remove("active"),r.classList.remove("active"),this.setDisplayMode("grabbing"))}),i.addEventListener("click",()=>{i.classList.contains("active")||(this.trailEditorController.setTrailEditorMode(!1),i.classList.add("active"),e.classList.remove("active"),r.classList.remove("active"),this.setDisplayMode("flat"))}),r.addEventListener("click",()=>{r.classList.contains("active")||(r.classList.add("active"),e.classList.remove("active"),i.classList.remove("active"),this.trailEditorController.setTrailEditorMode(!0))})}setPointPlacementMode(t){if(this.mapContainer)if(t){if(this.mapContainer.classList.add("point-placement-mode"),this.mapSvg&&(this.mapSvg.style.pointerEvents="auto",this.mapSvg.contentDocument)){this.mapSvg.contentDocument.querySelectorAll("path, rect, circle, polygon, polyline").forEach(r=>{r.style.pointerEvents="none"});const i=this.mapSvg.contentDocument.querySelector("svg");i&&(i.style.pointerEvents="auto")}this.dragController.setEnabled(!1),this.compassController.setEnabled(!1),this.displayMode==="flat"&&(this.displayMode="grabbing")}else{this.mapContainer.classList.remove("point-placement-mode");const e=document.querySelector(".marker-options");e&&e.classList.contains("visible")&&e.classList.remove("visible"),document.querySelectorAll(".marker-option-btn.active").forEach(r=>r.classList.remove("active")),this.restoreNavigation()}this.markerController.setPointPlacementMode(t)}restoreNavigation(){const t=document.querySelector(".mode-btn.mode-navigation"),e=document.querySelector(".mode-btn.mode-interaction"),i=document.querySelector(".mode-btn.mode-trail-creation");this.trailEditorController.setTrailEditorMode(!1);let r="grabbing";t&&e&&i&&(e.classList.contains("active")?r="flat":i.classList.contains("active")&&(r="grabbing",t.classList.add("active"),i.classList.remove("active"))),this.setDisplayMode(r),this.mapContainer&&(this.mapContainer.classList.remove("point-placement-mode"),this.mapContainer.classList.remove("trail-creation-mode")),r==="grabbing"?this.notificationController.showNotification("Mode navigation actif. Vous pouvez à nouveau déplacer et pivoter la carte."):this.notificationController.showNotification("Mode interaction actif. Les éléments de la carte sont à nouveau cliquables.")}setFlatInteractionMode(t){if(this.mapContainer)switch(this.mapContainer.classList.remove("interaction-select","interaction-add-point"),this.mapContainer.classList.add(`interaction-${t}`),t){case"select":this.notificationController.showNotification("Mode sélection activé. Cliquez sur les éléments pour les sélectionner.");break;case"add_point":this.notificationController.showNotification("Mode ajout de points activé. Cliquez sur la carte pour ajouter des points.");break}}setDisplayMode(t){if(console.log("Changement de mode d'affichage:",this.displayMode,"->",t),this.displayMode=t,this.mapContainer&&this.mapSvg)if(this.mapContainer.classList.remove("mode-grabbing","mode-flat","mode-trail-creation"),this.mapContainer.classList.add(`mode-${t}`),this.dragController.setDisplayMode(t),this.uiController.setDisplayMode(t),this.compassController.setDisplayMode(t),t==="flat"){if(console.log("Configuration du mode FLAT"),this.transformController.setFlatMode(!0),this.mapSvg.style.pointerEvents="auto",this.mapSvg.contentDocument){const i=this.mapSvg.contentDocument.querySelectorAll("path, rect, circle, polygon, polyline");console.log("Mode FLAT: configuration de",i.length,"éléments SVG");const r=s=>{if(s.getAttribute("fill-rule")==="evenodd")return!0;const a=s.getAttribute("style")||"";return a.includes("fill-rule:evenodd")||a.includes("fill-rule: evenodd")};i.forEach(s=>{if(r(s)){s.style.pointerEvents="none";return}s.style.pointerEvents="auto"})}this.setFlatInteractionMode("select"),this.notificationController.showNotification("Mode interaction activé. Les éléments de la carte sont cliquables.")}else if(t==="trail_creation"){if(console.log("Configuration du mode TRAIL_CREATION"),this.transformController.setFlatMode(!0),this.mapSvg.style.pointerEvents="auto",this.mapSvg.contentDocument){const i=this.mapSvg.contentDocument.querySelectorAll("path, rect, circle, polygon, polyline");console.log("Mode TRAIL_CREATION: configuration de",i.length,"éléments SVG");const r=s=>{if(s.getAttribute("fill-rule")==="evenodd")return!0;const a=s.getAttribute("style")||"";return a.includes("fill-rule:evenodd")||a.includes("fill-rule: evenodd")};i.forEach(s=>{if(r(s)){s.style.pointerEvents="none";return}if(s.style.pointerEvents="auto",!s.hasAttribute("data-selected-for-trail")){if(s.hasAttribute("data-original-stroke")){const o=s.getAttribute("data-original-stroke");o?s.setAttribute("stroke",o):s.removeAttribute("stroke"),s.removeAttribute("data-original-stroke")}if(s.hasAttribute("data-original-stroke-width")){const o=s.getAttribute("data-original-stroke-width");o?s.setAttribute("stroke-width",o):s.removeAttribute("stroke-width"),s.removeAttribute("data-original-stroke-width")}if(s.hasAttribute("data-original-fill")){const o=s.getAttribute("data-original-fill");o?s.setAttribute("fill",o):s.removeAttribute("fill"),s.removeAttribute("data-original-fill")}}})}this.dragController.setEnabled(!1),this.compassController.setEnabled(!1),this.notificationController.showNotification("Mode création de parcours activé. Sélectionnez des éléments sur la carte pour créer votre parcours.")}else console.log("Configuration du mode GRABBING"),this.transformController.setFlatMode(!1),this.mapSvg.style.pointerEvents="none",this.dragController.setEnabled(!0),this.compassController.setEnabled(!0),this.notificationController.showNotification("Mode navigation activé. Vous pouvez déplacer et pivoter la carte.")}getDisplayMode(){return this.displayMode}getTrailEditorController(){return this.trailEditorController}showHelpTips(){localStorage.getItem("map_has_seen_rotation_tips")||(localStorage.setItem("map_has_seen_rotation_tips","true"),setTimeout(()=>{this.notificationController.showNotification("Faites glisser la boussole pour pivoter la carte")},1e3))}}class U{constructor(t){n(this,"container");n(this,"mapController",null);n(this,"template",`
    <div class="map-container" id="map-container">
      <div class="map-view">
        <object type="image/svg+xml" data="./assets/map.svg" class="map-svg" id="map-svg">
          Votre navigateur ne prend pas en charge les objets SVG
        </object>
      </div>
      
      <!-- Boussole circulaire -->
      <div class="compass-container">
        <div class="compass-circle">
          <div class="compass-directions">
            <span class="compass-direction north">N</span>
            <span class="compass-direction east">E</span>
            <span class="compass-direction south">S</span>
            <span class="compass-direction west">O</span>
          </div>
          <div class="compass-rotator" id="compass-rotator">
            <div class="compass-handle"></div>
            <div class="compass-line"></div>
          </div>
          <div class="compass-center" id="compass-reset"></div>
        </div>
      </div>
      
      <div class="map-controls">
        <div class="zoom-controls">
          <button id="zoom-in" class="control-btn" title="Zoom avant">+</button>
          <button id="zoom-out" class="control-btn" title="Zoom arrière">-</button>
        </div>
        <button id="reset" class="control-btn reset-btn" title="Réinitialiser la vue">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
            <path d="M3 3v5h5"></path>
          </svg>
        </button>
      </div>
    </div>
  `);this.container=t,this.render(),this.mapController=new O,document.dispatchEvent(new CustomEvent("mapInitialized",{detail:{mapInstance:this}}))}render(){const t=document.createElement("div");t.innerHTML=this.template,this.container.appendChild(t.firstElementChild)}getMapController(){return this.mapController}}class Y{constructor(t){n(this,"trail");n(this,"isSelected",!1);n(this,"element",null);n(this,"clickHandler",null);n(this,"defaultImage","data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgdmlld0JveD0iMCAwIDgwIDgwIiBmaWxsPSJub25lIj48cmVjdCB3aWR0aD0iODAiIGhlaWdodD0iODAiIGZpbGw9IiMxMTFjMjkiLz48cGF0aCBkPSJNNDAgMjBMMjkgNDVINTFMNDAgMjBaIiBmaWxsPSIjMTRjNzhiIi8+PHBhdGggZD0iTTI1IDUwQzI1IDQ3LjIzODYgMjcuMjM4NiA0NSAzMCA0NUgzN1Y2MEgyNVY1MFoiIGZpbGw9IiMzMzQxNTUiLz48cGF0aCBkPSJNNTUgNTBDNTUgNDcuMjM4NiA1Mi43NjE0IDQ1IDUwIDQ1SDQzVjYwSDU1VjUwWiIgZmlsbD0iIzMzNDE1NSIvPjwvc3ZnPg==");this.trail=t}render(){const t=document.createElement("div");t.className="trail-card",t.setAttribute("data-id",this.trail.id);const e=this.getDifficultyInfo(this.trail.difficulty);return t.innerHTML=`
      <div class="trail-image">
        <img src="${this.trail.image}" alt="${this.trail.name}" onerror="this.onerror=null; this.src='${this.defaultImage}'">
      </div>
      <div class="trail-info">
        <h3 class="trail-name">${this.trail.name}</h3>
        
        <div class="trail-details">
          <div class="trail-metrics">
            <div class="trail-difficulty ${e.className}">
              ${e.text}
            </div>
            <div class="trail-distance">${this.trail.distance} km</div>
          </div>
          
          <div class="trail-type">${this.trail.type}</div>
        </div>
      </div>
    `,t.addEventListener("click",()=>{this.clickHandler&&(this.clickHandler(this.trail),this.highlightOnMap(this.trail))}),this.element=t,t}getDifficultyInfo(t){switch(t){case 1:return{text:"Facile",className:"difficulty-easy"};case 2:return{text:"Modéré",className:"difficulty-medium"};case 3:return{text:"Difficile",className:"difficulty-hard"};default:return{text:"Inconnu",className:""}}}setClickHandler(t){this.clickHandler=t}select(){this.element&&(this.isSelected=!0,this.element.classList.add("selected"))}deselect(){this.element&&(this.isSelected=!1,this.element.classList.remove("selected"))}isCardSelected(){return this.isSelected}highlightOnMap(t){var s,o,a;const i=(o=(s=document.getElementById("map-svg").contentDocument)==null?void 0:s.querySelector("svg"))==null?void 0:o.querySelectorAll("path."+t.id);for(const u of i){var r=(a=u==null?void 0:u.getAttribute("style"))==null?void 0:a.replace("rgb(255, 255, 255);","rgb(66,133,244);").replace("rgb(255,255,255);","rgb(66,133,244);").replace("stroke-opacity:0.4;","stroke-opacity:1;").replace("stroke-opacity: 0.4;","stroke-opacity:1;");u==null||u.setAttribute("style",r)}}}class Z{constructor(t,e=[],i){n(this,"container");n(this,"trails",[]);n(this,"cards",[]);n(this,"selectedTrailId",null);n(this,"trailSelectHandler",null);n(this,"trailEditorController",null);this.container=t,this.trails=e,this.trailEditorController=i||null,this.setupTrailsList(),document.addEventListener("trailCreationFinished",r=>{const s=r;if(s.detail&&s.detail.trail){console.log("Nouveau parcours créé avec éléments SVG:",s.detail.trail);const o={...s.detail.trail,svgElements:s.detail.trail.svgElements||[]};this.addTrail(o)}})}setupTrailsList(){const t=document.createElement("div");t.className="trails-container";const e=document.createElement("h2");e.className="trails-title",e.textContent="Parcours disponibles",t.appendChild(e);const i=document.createElement("div");i.className="trails-list",this.trails.forEach(r=>{const s=new Y(r);s.setClickHandler(o=>{this.handleTrailSelection(o)}),this.cards.push(s),i.appendChild(s.render())}),t.appendChild(i),this.container.appendChild(t)}handleTrailSelection(t){if(this.selectedTrailId){const i=this.cards.find(r=>r.isCardSelected());i&&i.deselect()}const e=this.cards.find(i=>i.render().getAttribute("data-id")===t.id);if(e){if(e.select(),this.selectedTrailId=t.id,this.trailEditorController){const i=document.getElementById("map-container");if(i&&(i.classList.remove("mode-grabbing","mode-trail-creation"),i.classList.add("mode-flat")),t.svgElements&&t.svgElements.length>0)console.log("Utilisation des éléments SVG directement depuis le parcours:",t),this.trailEditorController.highlightTrail(t);else{const r=localStorage.getItem("map_trails")||"[]",o=JSON.parse(r).find(a=>a.id===t.id);o&&o.svgElements&&o.svgElements.length>0?(console.log("Parcours complet trouvé dans localStorage, mise en surbrillance:",o),this.trailEditorController.highlightTrail(o)):console.warn(`Impossible de trouver les éléments SVG pour le parcours ${t.id}`)}}this.trailSelectHandler&&this.trailSelectHandler(t)}}setTrails(t){this.trails=t,this.cards=[],this.selectedTrailId=null,this.container.innerHTML="",this.setupTrailsList()}getSelectedTrail(){return this.selectedTrailId&&this.trails.find(t=>t.id===this.selectedTrailId)||null}setTrailSelectHandler(t){this.trailSelectHandler=t}addTrail(t){console.log("Ajout du parcours à la liste avec éléments SVG:",t);const e=this.trails.findIndex(i=>i.id===t.id);e!==-1?this.trails[e]=t:this.trails.push(t),this.container.innerHTML="",this.cards=[],this.setupTrailsList(),this.updateLocalStorage()}updateLocalStorage(){const t=localStorage.getItem("map_trails")||"[]",e=JSON.parse(t);this.trails.forEach(i=>{const r=e.findIndex(s=>s.id===i.id);if(r!==-1){const s=e[r];e[r]={...i,svgElements:i.svgElements||s.svgElements}}else e.push(i)}),localStorage.setItem("map_trails",JSON.stringify(e))}setTrailEditorController(t){this.trailEditorController=t}}const _=[{id:"trail-1",name:"Découvrir la Chantrerie",difficulty:3,distance:8.5,type:"Randonnée pédestre",image:"./assets/images/trail-waterfall.jpg"},{id:"trail-2",name:"Le senstier des mines",difficulty:1,distance:1.2,type:"Promenade",image:"./assets/images/trail-lake.jpg"}];function W(){return new Promise(d=>{const t=localStorage.getItem("map_trails")||"[]",i=JSON.parse(t).map(s=>({id:s.id,name:s.name,difficulty:s.difficulty||1,distance:typeof s.distance=="number"?s.distance:1,type:s.type||"Randonnée pédestre",image:s.image||"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgdmlld0JveD0iMCAwIDgwIDgwIiBmaWxsPSJub25lIj48cmVjdCB3aWR0aD0iODAiIGhlaWdodD0iODAiIGZpbGw9IiMxMTFjMjkiLz48cGF0aCBkPSJNNDAgMjBMMjkgNDVINTFMNDAgMjBaIiBmaWxsPSIjMTRjNzhiIi8+PHBhdGggZD0iTTI1IDUwQzI1IDQ3LjIzODYgMjcuMjM4NiA0NSAzMCA0NUgzN1Y2MEgyNVY1MFoiIGZpbGw9IiMzMzQxNTUiLz48cGF0aCBkPSJNNTUgNTBDNTUgNDcuMjM4NiA1Mi43NjE0IDQ1IDUwIDQ1SDQzVjYwSDU1VjUwWiIgZmlsbD0iIzMzNDE1NSIvPjwvc3ZnPg=="})),r=[..._,...i];setTimeout(()=>{d(r)},300)})}const X=[{id:"trail-1",photos:["./assets/images/trailOne/1.jpg","./assets/images/trailOne/2.jpg","./assets/images/trailOne/3.jpg","./assets/images/trailOne/4.jpg"],descriptions:["Regarde le soleil pendant 1 minute sans fermer les yeux et essaye de marcher vers l'Est sur 700 pas.","Suit le chat de youcef jusqu'au prochain indice.","Cherche un sous-sol et rentre dedans.","Fais une offrande au dieu sous l'Erdre."],alts:["Le soleil","Le chat de Youcef","Une entrée cachée dans le sol","Un autel"]},{id:"trail-2",photos:["./assets/images/trailTwo/1.jpg","./assets/images/trailTwo/2.jpg","./assets/images/trailTwo/3.jpg","./assets/images/trailTwo/4.jpg"],descriptions:["La flemme de sortir un indice","La flemme de sortir un indice","La flemme de sortir un indice","La flemme de sortir un indice"],alts:["premier alt","deuxième alt","troisième alt","quatrième alt"]}];class J{constructor(t,e,i){n(this,"photo");n(this,"description");n(this,"alt");this.photo=t,this.description=e,this.alt=i}render(){const t=document.createElement("div");return t.className="trail-step-card",t.innerHTML=`
        <div class="trail-image">
            <img src="${this.photo}" alt="${this.alt}">
        </div>
        <div class="trail-info">
            <h1 class="trail-name">${this.description}</h1>
        </div>
        `,t}}class K{constructor(t){n(this,"container");n(this,"sidebarTemplate",`
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <img src="./assets/images/apsa-logo.png" alt="APSA Logo" class="sidebar-logo" />
        <h1>APSA Carte Interactive</h1>
      </div>
      
      <div class="sidebar-content" id="sidebar-content">
      </div>
      
      <div class="sidebar-footer">
        <button class="action-btn secondary" id="sidebar-reset">Réinitialiser</button>
        <button class="action-btn" id="sidebar-action">Explorer</button>
      </div>
    </div>
  `);n(this,"toggleButtonTemplate",`
    <div class="toggle-button-container" id="toggle-button-container">
      <button class="sidebar-toggle" id="sidebar-toggle" title="Replier/Déplier le panneau"></button>
    </div>
  `);n(this,"sidebarElement",null);n(this,"toggleButtonElement",null);n(this,"isCollapsed",!1);n(this,"trailsList",null);n(this,"_pendingTrailEditorController",null);n(this,"selectedTrail",null);this.container=t,this.render(),this.setupEventListeners(),this.restoreCollapseState(),this.loadTrails(),document.addEventListener("mapInitialized",e=>{const i=e;i.detail&&i.detail.mapInstance&&this.connectToMapController(i.detail.mapInstance)}),document.addEventListener("trailCreationFinished",e=>{console.log("Événement trailCreationFinished reçu:",e.detail),this.loadTrails()})}render(){const t=document.createElement("div");t.innerHTML=this.sidebarTemplate,this.container.appendChild(t.firstElementChild),this.sidebarElement=document.getElementById("sidebar");const e=document.createElement("div");e.innerHTML=this.toggleButtonTemplate,this.container.appendChild(e.firstElementChild),this.toggleButtonElement=document.getElementById("toggle-button-container")}setupEventListeners(){const t=document.getElementById("sidebar-reset"),e=document.getElementById("sidebar-action"),i=document.getElementById("sidebar-toggle");t&&t.addEventListener("click",()=>{this.resetContent()}),e&&e.addEventListener("click",()=>{this.performAction()}),i&&i.addEventListener("click",s=>{s.stopPropagation(),this.toggleSidebar()});const r=window.matchMedia("(max-width: 480px)");this.handleResponsiveLayout(r),r.addEventListener("change",s=>this.handleResponsiveLayout(s)),document.addEventListener("keydown",s=>{s.key==="Escape"&&!this.isCollapsed&&this.toggleSidebar()})}toggleSidebar(){this.sidebarElement&&(this.isCollapsed=!this.isCollapsed,this.isCollapsed?(this.sidebarElement.classList.add("collapsed"),this.sidebarElement.classList.remove("open")):(this.sidebarElement.classList.remove("collapsed"),window.matchMedia("(max-width: 480px)").matches&&this.sidebarElement.classList.add("open")),localStorage.setItem("sidebar_collapsed",this.isCollapsed.toString()),window.dispatchEvent(new Event("resize")))}restoreCollapseState(){var e;localStorage.getItem("sidebar_collapsed")==="true"&&(this.isCollapsed=!0,(e=this.sidebarElement)==null||e.classList.add("collapsed"))}handleResponsiveLayout(t){if(t.matches){this.toggleButtonElement&&(this.toggleButtonElement.style.display="block",this.toggleButtonElement.style.left="0",this.toggleButtonElement.style.top="50%",this.toggleButtonElement.style.position="fixed");const e=document.getElementById("sidebar-toggle-btn");e&&e.remove()}else{this.toggleButtonElement&&(this.toggleButtonElement.style.position="",this.toggleButtonElement.style.left="",this.toggleButtonElement.style.top="",this.toggleButtonElement.style.display="");const e=document.getElementById("sidebar-toggle-btn");e&&e.remove()}}updateContent(t){const e=document.getElementById("sidebar-content");e&&(e.innerHTML=t)}resetContent(){this.loadTrails()}performAction(){var e;const t=(e=this.trailsList)==null?void 0:e.getSelectedTrail();t&&console.log("Action sur le parcours:",t.name)}async loadTrails(){const t=document.getElementById("sidebar-content");if(t){t.innerHTML='<div class="loading">Chargement des parcours...</div>';try{const e=await W();t.innerHTML="",this.trailsList=new Z(t,e),this._pendingTrailEditorController&&(this.trailsList.setTrailEditorController(this._pendingTrailEditorController),this._pendingTrailEditorController=null),this.trailsList.setTrailSelectHandler(i=>{this.handleTrailSelection(i)})}catch{t.innerHTML='<div class="error">Erreur lors du chargement des parcours.</div>'}}}showTrailDetails(t){const e=document.getElementById("sidebar-content");if(!e)return;const i=X.find(u=>u.id===t);if(!i){e.innerHTML='<div class="error">Détails non disponibles pour ce parcours.</div>';return}let r=0;const s=u=>{const l=new J(i.photos[u],i.descriptions[u],i.alts[u]),c=e.querySelector(".trail-details");c&&c.appendChild(l.render())};e.innerHTML=`
    <div class="trail-details"></div>
    <button class="action-btn secondary" id="next-hint">Prochain indice</button>
    <button class="action-btn secondary" id="back-to-trails">Retour</button>
  `,s(r);const o=document.getElementById("next-hint");o&&o.addEventListener("click",()=>{r++,s(r),r===i.photos.length-1&&(o.style.display="none")});const a=document.getElementById("back-to-trails");a&&a.addEventListener("click",()=>{this.resetContent(),this.hideTrailOnMap()})}handleTrailSelection(t){console.log(`Parcours sélectionné: ${t.name}`),this.showTrailDetails(t.id),this.selectedTrail=t}hideTrailOnMap(){var r,s,o,a,u,l;const e=(o=(r=document.getElementById("map-svg").contentDocument)==null?void 0:r.querySelector("svg"))==null?void 0:o.querySelectorAll("path."+((s=this.selectedTrail)==null?void 0:s.id));for(const c of e){var i=(a=c==null?void 0:c.getAttribute("style"))==null?void 0:a.replace("rgb(66,133,244);","rgb(255,255,255);");(u=c==null?void 0:c.getAttribute("class"))!=null&&u.includes("ch")&&(i=(l=c==null?void 0:c.getAttribute("style"))==null?void 0:l.replace("stroke-opacity:1;","stroke-opacity:0.4;").replace("rgb(66,133,244);","rgb(255,255,255);")),c==null||c.setAttribute("style",i)}}connectToMapController(t){if(!t||!t.getMapController)return;const e=t.getMapController();if(!e)return;const i=e.getTrailEditorController();i&&(this.trailsList?this.trailsList.setTrailEditorController(i):this._pendingTrailEditorController=i)}}class T{static onDomReady(t){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()}static getElementById(t){return document.getElementById(t)}}function Q(){document.querySelector("#app").innerHTML=`
    <div id="main-content"></div>
  `;const d=T.getElementById("main-content");d&&(new K(d),new U(d))}T.onDomReady(Q);
